<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—</title>
    <link rel="stylesheet" href="styles.css">
    <!-- CDNåŠ è½½ä¼˜åŒ–è„šæœ¬ -->
    <script>
        const CDN_CONFIG = {
            supabase: [
                'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2',
                'https://unpkg.com/@supabase/supabase-js@2',
                'https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js',
                'https://fastly.jsdelivr.net/npm/@supabase/supabase-js@2',
                'https://cdn.skypack.dev/@supabase/supabase-js@2'
            ]
        };

        class CDNLoader {
            constructor() { this.timeout = 8000; }
            loadScript(url) {
                return new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = url;
                    const t = setTimeout(() => { s.remove(); reject(new Error(`åŠ è½½è¶…æ—¶: ${url}`)); }, this.timeout);
                    s.onload = () => { clearTimeout(t); resolve(url); };
                    s.onerror = () => { clearTimeout(t); s.remove(); reject(new Error(`åŠ è½½å¤±è´¥: ${url}`)); };
                    document.head.appendChild(s);
                });
            }
            async loadWithFallback(name, urls) {
                console.log(`ğŸš€ å¼€å§‹åŠ è½½ ${name}ï¼Œå°è¯•é¡ºåº`, urls);
                for (let i = 0; i < urls.length; i++) {
                    try {
                        const u = urls[i];
                        await this.loadScript(u);
                        if (name === 'supabase') await this.waitForSupabase();
                        console.log(`âœ… ${name} åŠ è½½æˆåŠŸ: ${u}`);
                        return u;
                    } catch (e) {
                        console.warn(`${name} CDNå¤±è´¥ (${i+1}/${urls.length}):`, e.message);
                        if (i === urls.length - 1) throw new Error(`æ‰€æœ‰ ${name} CDN æºå‡ä¸å¯ç”¨`);
                        await new Promise(r => setTimeout(r, 500));
                    }
                }
            }
            waitForSupabase() {
                return new Promise((resolve, reject) => {
                    let n = 0; const max = 50;
                    const check = () => {
                        n++;
                        if (window.supabase && typeof window.supabase.createClient === 'function') return resolve();
                        if (n >= max) return reject(new Error('Supabase éªŒè¯è¶…æ—¶'));
                        setTimeout(check, 100);
                    };
                    check();
                });
            }
            showLoadingStatus(message, type = 'info') {
                const ex = document.querySelector('.status-indicator');
                if (ex) ex.remove();
                const el = document.createElement('div');
                el.className = `status-indicator ${type}`;
                el.textContent = message;
                document.body.appendChild(el);
                setTimeout(() => { if (el && el.parentNode) el.remove(); }, type === 'error' ? 8000 : 3000);
            }
        }
        const cdnLoader = new CDNLoader();
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                cdnLoader.showLoadingStatus('æ­£åœ¨åŠ è½½æ•°æ®åº“è¿æ¥...', 'info');
                const supabaseUrl = await cdnLoader.loadWithFallback('supabase', CDN_CONFIG.supabase);
                cdnLoader.showLoadingStatus('CDNåŠ è½½å®Œæˆ', 'success');
                console.log('ğŸ‰ Supabase CDNåŠ è½½å®Œæˆ', supabaseUrl);
                window.dispatchEvent(new CustomEvent('cdnReady', { detail: { supabase: supabaseUrl } }));
            } catch (error) {
                console.error('âŒ CDNåŠ è½½å¤±è´¥:', error);
                cdnLoader.showLoadingStatus('CDNåŠ è½½å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨', 'error');
                window.dispatchEvent(new CustomEvent('cdnError', { detail: { error: error.message } }));
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1 class="page-title">æ—¥å¿—</h1>
        <form id="logForm" class="form-container">
            <textarea id="logContent" name="content" rows="3" class="form-textarea" placeholder="éšæ‰‹è®°å½•ç‚¹ä»€ä¹ˆ..." required></textarea>
            <div class="form-actions">
                <button type="button" id="cancelBtn" class="btn btn-cancel hidden">å–æ¶ˆ</button>
                <button type="submit" id="submitBtn" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
        <div id="timeline" class="timeline-container"><!-- æ—¥å¿—æ¡ç›® --></div>
        <div id="emptyState" class="empty-state hidden">æš‚æ— æ—¥å¿—</div>
    </div>
    <div id="deleteModal" class="modal hidden">
        <div class="modal-content">
            <p class="modal-text">ç¡®å®šåˆ é™¤ï¼Ÿ</p>
            <div class="modal-actions">
                <button id="cancelDelete" class="btn btn-cancel">å–æ¶ˆ</button>
                <button id="confirmDelete" class="btn btn-danger">åˆ é™¤</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>

